// Function resizes YouTube and Vimeo embed code to have fluid width for responsive design
jQuery(function($) {
    var domains = ['https://player.vimeo.com', 'https://www.youtube.com','//www.youtube.com',"https://maps.google.com","https://www.google.com/maps"],
        video_domains_regex = "www\.pbhs-sites\.com\/adalibrary",
        tags = ['object', 'embed'],
        selector = "",
        video_selector = "",
        objects,
        videos,
        fluid_boxes;

    //Build Selector String
    $.each(domains, function(i) { selector += ", iframe[src^='"+this+"']:not(.static)"; });
    $.each(tags, function(i) { selector += ", "+this+":not(.static,[name='topbar'])"; });

    $.fluidBox = function() {
        // Update selected objects
        objects = $(selector.substring(2));
        videos = $('video');

        videos.each(function() {
            var valid = false,
                has_dims = this.width && this.height,
                regex = new RegExp(video_domains_regex, "i");

            if(this.src && has_dims) {
                valid = regex.test(this.src);
            } else if(has_dims) {
                var sources = $('source', this);
                sources.each(function() {
                    valid || (valid = regex.test(this.src));
                });
            }

            if(valid) { $(this).addClass('fluid-box-video').data('ratio', this.width/this.height); }
        });

        // Wrap in figure element if not already
        objects.each(function() {
            var self = $(this);
            if(!self.parent().hasClass('fluid-box'))
            {
                //if height is a percent then exit
                if(this.height[this.height.length - 1] === '%') {
                    return;
                }
                var aspect_ratio = this.height / this.width;
                //if aspect_ratio is not a number exit
                if(isNaN(aspect_ratio)){
                    return;
                }
                self
                    .wrap('<figure class="fluid-box"></figure>')
                    // jQuery .data does not work on object/embed elements
                    .attr('data-aspectRatio', aspect_ratio)
                    .removeAttr('height')
                    .removeAttr('width');
            }
        });

        // Update selected figures
        fluid_boxes = $("figure.fluid-box");

        $(window).resize(function() {
            //console.log('as');
            objects.each(function(i) {
                var el = $(this), new_w = $(fluid_boxes.get(i)).width();
                el
                    .width(new_w)
                    .height(new_w * el.attr('data-aspectRatio'));
            });

            videos.filter('.fluid-box-video').each(function() {
                var self = $(this);
                self.css( 'height', self.width()/self.data('ratio') );
            });
        }).resize();
    };

    $.fluidBox();
});